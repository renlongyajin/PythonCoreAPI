# AI 法律问答系统——详细开发手册

## 1. 开发目标与约束
- **首要目标**：搭建 Python 后端（FastAPI）并打通用户管理、权限控制、配置加载、数据库读写等基础设施；确保 API 稳定、向后兼容。
- **次要目标**：在基础设施稳定后，再实现法规数据 CRUD、检索与问答链路，确保每一步都有可运行版本。
- **铁律**：
  1. 所有数据以 PostgreSQL（含 pgvector）为唯一事实来源，不引入多套存储。
  2. API 全部挂载在 `/api/v1`，任何破坏性改动以新版本发布。
  3. 模块之间只通过定义好的接口交互，禁止跨层直接访问数据库会话。

## 2. 工程结构与责任边界
```
app/
  main.py                # FastAPI 入口
  dependencies.py        # 全局依赖注入定义
  core/
    config.py            # Pydantic Settings
    security.py          # 密码哈希、JWT 工具
    middleware.py        # 日志、追踪、限流
    exception.py         # 统一异常封装
  db/
    base.py              # SessionLocal、Base
    models/              # SQLAlchemy 模型（按模块拆分）
    migrations/          # Alembic 迁移
  apps/
    auth/
      router.py
      service.py
      schemas.py
      repository.py
    laws/
      router.py
      service.py
      schemas.py
      repository.py
    retrieval/
      router.py
      pipeline.py
      schemas.py
    qa/
      router.py
      service.py
      schemas.py
  infrastructure/
    cache.py             # Redis 客户端
    task_queue.py        # Celery client
    llm_client.py        # LLM API 封装
tests/
  ...                    # Pytest 按模块分层
```

## 3. 技术栈基线
- **语言 & 运行时**：Python 3.11，uvicorn 作为 ASGI server。
- **Web 框架**：FastAPI + Starlette，自带依赖注入、OpenAPI。
- **ORM & DB**：SQLAlchemy 2.x + Alembic，PostgreSQL 15（启用 `pgvector`）。
- **缓存/队列**：Redis 7（同时作为 Celery Broker/Backend）。
- **安全**：bcrypt（密码）、PyJWT（Token）、fastapi-limiter（基于 Redis 的限流）。
- **测试**：Pytest、httpx、pytest-asyncio。

## 4. 数据模型与类设计

### 4.1 Auth 模块
- **SQLAlchemy 模型** `User`, `Role`, `UserRole`：
  - `User`：`id`, `email`, `password_hash`, `full_name`, `is_active`, `created_at`。
  - `Role`：`id`, `name`, `description`。
  - `UserRole`：`user_id`, `role_id`（联合唯一）。
- **Pydantic Schemas**：
  - `UserCreate`、`UserRead`、`UserUpdate`。
  - `TokenPair`（access_token, refresh_token, expires_in）。
  - `LoginRequest`（email, password）。
- **Service 类**：`AuthService`
  - 依赖 `UserRepository` + `TokenProvider`（core.security）。
  - 方法：`register_user(data)`、`authenticate(email, password)`、`refresh(refresh_token)`。
- **Repository 类**：`UserRepository`
  - 方法：`get_by_email`, `create`, `update`, `list_roles`, `set_roles`。

### 4.2 Laws 模块
- **模型**：`Law`, `LawSection`, `LawArticle`, `LawTag`, `LawArticleTag`。
- **Pydantic**：`LawCreate`, `LawRead`, `SectionCreate`, `ArticleCreate`, `TagCreate` 等。
- **Service**：`LawService`
  - 方法：`create_law`, `import_law_package`, `list_laws`, `update_article`, `attach_tags`。
- **Repository**：负责 CURD 与批量导入，提供 `bulk_upsert_sections` 等无特例接口。

### 4.3 Retrieval 模块
- **模型**：`LawChunk`（`id`, `article_id`, `content`, `embedding`, `token_count`, `version`）。
- **Pipeline 类**：`ChunkPipeline`
  - 步骤：`split(document)` → `embed(chunks)` → `store(chunks)`。
- **Repository**：读写 `LawChunk` 与 `EmbeddingJob` 任务表，所有 embedding 操作在事务内完成。

### 4.4 QA 模块
- **模型**：`QASession`, `QAFeedback`。
- **Service**：`QAService`
  - `ask(question, user)`：编排检索 → LLM → 结构化解析。
  - `record_feedback(session_id, score, comment)`。
- **Pydantic**：`QuestionRequest`, `AnswerResponse`, `FeedbackRequest`。

## 5. API 接口定义（重点关注用户/权限）

### 5.1 Auth Router (`/api/v1/auth`)
| 方法 | 路径 | 描述 | 请求体 | 响应 |
| --- | --- | --- | --- | --- |
| POST | `/register` | 注册新用户（仅管理员可调用） | `UserCreate` | `UserRead` |
| POST | `/login` | 用户登录 | `LoginRequest` | `TokenPair` |
| POST | `/refresh` | 刷新 Token | `refresh_token` | `TokenPair` |
| GET | `/me` | 获取当前用户 | header: Bearer | `UserRead` |
| PATCH | `/me` | 修改个人信息 | `UserUpdate` | `UserRead` |

### 5.2 Role Router (`/api/v1/roles`)
| 方法 | 路径 | 描述 | 权限 |
| --- | --- | --- | --- |
| GET | `/` | 列出角色 | `admin` |
| POST | `/` | 创建角色 | `admin` |
| PUT | `/{role_id}/users/{user_id}` | 绑定角色 | `admin` |
| DELETE | `/{role_id}` | 删除角色 | `admin` |

### 5.3 Laws Router (`/api/v1/laws`)
- `GET /`：分页查询法规（查询参数：keyword, tag, updated_after）。
- `POST /`：创建法规及章节，Body 使用 `LawCreate`，内部调用 `LawService.create_law`。
- `POST /import`：上传法规包（Zip/JSON），交给 Celery 处理，返回 `job_id`。
- `GET /{law_id}` / `PATCH /{law_id}`：读取/更新法规。
- `POST /articles/{article_id}/tags`：维护标签。

### 5.4 Retrieval Router (`/api/v1/retrieval`)
- `POST /chunks/rebuild`：触发指定法规的切分+向量重建（管理员）。
- `GET /search`：查询相似条文，请求参数 `query`, `top_k`，返回 `LawChunk` 列表。

### 5.5 QA Router (`/api/v1/qa`)
- `POST /ask`：请求体 `QuestionRequest`（question, context, user_constraints），返回 `AnswerResponse`（citations, analysis, recommendation, trace_id）。
- `POST /feedback`：提交问答反馈。

## 6. 开发顺序（里程碑内的详细步骤）
1. **基础设施引导**
   - 初始化 FastAPI 项目、Pydantic Settings、日志中间件、health check。
   - 配置 SQLAlchemy `SessionLocal`、Alembic；写首个迁移（users/roles）。
2. **用户与权限**
   - 实现 `User`/`Role` 模型和仓储；完成注册、登录、刷新、`/me` 接口。
   - 引入 RBAC 依赖：Router 装饰器 `@router.get(..., dependencies=[Depends(require_roles("admin"))])`。
   - 编写 Pytest 覆盖登录、权限拒绝、刷新流程。
3. **配置与运维基线**
   - 实现 `.env` 加载、Secrets 管理、配置热更新（重启进程）。
   - 接入结构化日志、Sentry/Prometheus 钩子。
4. **法规数据 CRUD**
   - 建表 `laws/law_sections/law_articles`，完成基本 CRUD API 与校验。
   - 支持批量导入（后台任务）与标签体系。
5. **检索与切分**
   - 建表 `law_chunks`，实现 `ChunkPipeline`，封装 pgvector 写入与查询。
   - 暴露 `/retrieval/search` 接口并添加缓存。
6. **问答编排**
   - 搭建 `QAService`，串联检索结果与 LLM 客户端，输出结构化回答。
   - 记录 `qa_sessions`/`qa_feedback`，支撑审计与优化。
7. **异步任务与监控完善**
   - Celery Worker 负责导入、重建向量、质量报告。
   - 增加限流、中断恢复、任务重试策略。

## 7. 依赖与交互约定
- **依赖注入**：所有 Router 通过 `Depends(get_db)` / `Depends(get_current_user)` 获取资源，禁止全局变量。
- **事务管理**：Repository 内使用显式事务，Service 层不直接控制提交，以保障一致性。
- **日志 & Trace**：每个请求生成 `trace_id`，QA 模块把 `trace_id` 回写，方便问题定位。
- **错误约定**：统一返回 `{code, message, details}`，常量定义在 `core/exception.py`。

## 8. 测试与验收
- **单元测试**：
  - Auth：密码哈希、JWT 过期校验、权限拦截。
  - Laws：CRUD、导入校验、标签绑定。
  - Retrieval：切分数量、向量写入、搜索 Top-K。
  - QA：Mock LLM，验证响应格式与引用。
- **集成测试**：使用 httpx 对 `/api/v1` 全量跑通；涉及数据库的测试使用事务回滚。
- **性能验证**：对 `/auth/login`、`/retrieval/search`、`/qa/ask` 进行基准测试，记录 QPS 与 P95 延迟。

## 9. 运维与上线要点
- 构建镜像时只安装运行所需依赖，避免容器内的多环境特例。
- 数据迁移前在预生产执行 `alembic upgrade --sql` 生成 SQL，确认无破坏操作。
- 使用 `docker compose -f deploy/docker-compose.yml` 启动全部组件，生产环境切至 K8s 仅需替换配置。
- 所有配置通过环境变量传入，禁止硬编码秘钥。

> 本手册随迭代更新，但必须优先保证用户与权限模块的稳定性；任何新增特性都需回答“是否会破坏现有用户”的问题后才能实施。
