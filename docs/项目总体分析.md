# AI 法律问答系统——项目总体分析

## 1. 项目愿景与业务目标
- **目标用户**：面向法务、律师以及需要法规依据的业务人员，提供可靠的法规问答助手。
- **核心价值**：快速定位相关法条，输出条文引用 + 分析 + 建议的结构化回答，降低检索成本。
- **成功指标**：首屏响应 < 3s，条文引用准确率 > 90%，可追溯所有生成内容。

### 1.1 设计原则对齐
- **真实问题优先**：所有功能都直接服务“找法规+答问题”，不做与问答无关的实验性特性。
- **先做最简单的事**：单一技术栈（FastAPI + PostgreSQL + Redis）先跑通，后续扩展只在容量证明不足时才引入新组件。
- **绝不破坏用户**：API 强制版本号，数据库迁移保持向后兼容，历史问答可重放以验证升级。

## 2. 技术选型与系统分层
- **后端框架**：FastAPI（异步、高性能、自动文档）+ Pydantic Settings，统一入口 `main.py`，避免多框架并存。
- **数据访问**：SQLAlchemy + Alembic，所有结构化数据都落在 PostgreSQL，使用 `pgvector` 原地完成向量检索，杜绝多份数据拷贝。
- **检索与向量**：Embedding 首选 OpenAI API，必要时才切换本地模型；召回逻辑围绕 `pgvector` 单一实现，消除 FAISS/Milvus 等特例。
- **缓存与消息**：Redis 既做缓存也做 Celery 任务队列 Broker，明确一个事实来源；若未来要拆分，再通过配置层扩展。
- **部署形态**：Docker Compose 开发/测试 → 同一镜像上线至 K8s；Nginx 负责 TLS、限流与蓝绿发布，保持接口兼容。

### 2.1 模块划分
```
apps/
  auth/        # 拥有 users/roles 数据，暴露鉴权接口
  laws/        # 拥有 law_* 表，提供法规 CRUD 与导入
  retrieval/   # 只操作 law_chunks/embeddings，封装检索
  qa/          # 编排检索+LLM，输出问答 JSON
core/
  config/      # Settings、Env、Secrets（单一真相源）
  middleware/  # 日志、追踪、限流、异常处理
infrastructure/
  db/redis/llm 客户端（每类资源仅一个实现）
```

## 3. 核心模块说明
- **接入层（API 网关 + FastAPI Router）**：管理版本、鉴权、速率限制，并输出 OpenAPI/Swagger 文档。
- **Auth 模块**：注册、登录、刷新 Token、密码重置；采用 bcrypt 存储密码，Access/Refresh Token 由 PyJWT 签发，RBAC 权限通过依赖注入校验。
- **Laws 模块**：法规、章节、条文、标签等实体 CRUD；支持批量导入、版本管理、全文索引字段维护。
- **Retrieval 模块**：围绕 `law_chunks` 与 `embeddings` 表实现切分、Embedding、检索三步一体化流程，默认使用 `pgvector`，不再维护多套向量管线。
- **QA 模块**：实现检索增强生成（RAG）流水线，负责 Prompt 模板、候选条文过滤、思路链日志、响应结构化（引用、分析、结论）。
- **异步任务模块**：Celery Worker 处理法规入库、Embedding 批处理、模型评测等耗时任务。
- **监控与可观测性**：Prometheus + Grafana 采集指标，Sentry 记录异常，OpenTelemetry 输出链路追踪。

## 4. 关键流程
### 4.1 用户认证流程
1. 用户提交账号 + 密码 → 校验后返回 Access/Refresh Token。
2. 每次请求在 Header 中携带 Bearer Token，FastAPI 依赖验证并注入当前用户。
3. Token 过期后使用 Refresh 接口换取新 Token，过期或注销 Token 写入 Redis 黑名单。

### 4.2 法规问答（RAG）流程
1. 接收问题，进行意图识别与关键词抽取。
2. 调用 Retrieval 模块执行语义检索 + 可能的重排，返回候选条文。
3. QA 模块构建 Prompt（包含问题、候选条文、输出格式提示），调用 LLM 推理。
4. 将 LLM 输出解析为结构化 JSON，包含引用条文列表、分析、建议，并落库供回溯。
5. 结果写入缓存，并以流式或整块形式返回前端。

### 4.3 法规知识入库流程
1. 运营侧上传法规文档 → 触发解析任务，抽取章节、条文、版本信息。
2. 切分为语义片段，调用 Embedding 服务计算向量。
3. 将结构化字段与向量统一写入 PostgreSQL（pgvector），记录版本、来源与可回溯信息，避免多处存储。
4. 更新检索索引并生成质量报告（召回率、覆盖度）。

## 5. 数据与基础设施
- **数据库模型概览**：
  - `users`, `roles`, `user_roles`：用户、角色、绑定关系。
  - `laws`, `law_sections`, `law_articles`：法规、章节、条文层级。
  - `law_chunks`, `embeddings`：切分片段及其向量。
  - `qa_sessions`, `qa_feedback`：问答历史与用户反馈。
- **缓存策略**：热点问答、条文详情、配置表放入 Redis；检索结果短期缓存以降低数据库向量查询压力，所有缓存都以主键做 key，避免语义歧义。
- **对象存储**：法规原文、解析结果、导出报告存放在 MinIO/S3，记录元数据以便追踪。

## 6. 非功能要求
- **安全**：全链路 HTTPS，接口级 RBAC，敏感日志脱敏；审计日志记录所有问答和修改操作。
- **性能**：单节点 QPS ≥ 50，检索耗时 < 800ms，支持水平扩容；异步任务具备重试与超时控制。
- **兼容性**：API 固定 `v1` 前缀，任何破坏性改动都通过新版本暴露；数据库迁移保持幂等并提供回滚脚本。
- **可运维性**：提供健康检查、/metrics、日志结构化输出；CI/CD 自动运行单测、lint、打包镜像、部署。

## 7. 里程碑与下一步计划
1. **MVP**：完成用户认证、法规 CRUD、基础向量检索、问答 API（T+3 周）。
2. **增强阶段**：加入流式回答、反馈收集、召回评估、运营后台（T+6 周）。
3. **优化阶段**：上线多模型编排、知识图谱辅助、灰度 AB 测试、自动化监控告警（T+10 周）。

> 当前文档用于指导后续《详细开发手册》《下一步开发》内容的拆解与评审。
